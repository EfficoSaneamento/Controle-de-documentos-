<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>

<style>
:root{
  --green:#00c853;
  --red:#ff5252;
  --blue:#003399;
  --bg:#f0f2f5;
}

body{
  margin:0;
  font-family:Segoe UI,sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:20px;
}

.container{
  background:#fff;
  max-width:480px;
  width:100%;
  border-radius:18px;
  padding:24px;
  box-shadow:0 12px 30px rgba(0,0,0,.15);
  text-align:center;
}

.logo{width:120px;margin-bottom:8px;}
h1{color:var(--blue);font-size:1.4rem;}

.status{
  background:#e3f2fd;
  color:#0d47a1;
  padding:12px;
  border-radius:8px;
  margin:15px 0;
  font-weight:500;
}

.camera-box{
  display:none;
  position:relative;
  width:100%;
  aspect-ratio:4/3;
  background:#000;
  border-radius:16px;
  overflow:hidden;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.overlay{
  position:absolute;
  inset:0;
  display:flex;
  justify-content:center;
  align-items:center;
  pointer-events:none;
}

.mask{
  width:65%;
  height:75%;
  border:3px solid var(--red);
  border-radius:50%;
  box-shadow:0 0 0 999px rgba(0,0,0,.55);
  transition:.3s;
}

.mask.doc{
  width:78%;
  height:65%;
  border-radius:14px;
}

.mask.ok{
  border-color:var(--green);
  box-shadow:0 0 0 999px rgba(0,200,83,.25);
}

button{
  margin-top:15px;
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:#687b58;
  color:#fff;
  font-size:1rem;
  font-weight:bold;
  cursor:pointer;
}

canvas{display:none;}
</style>
</head>

<body>

<div class="container">
  <img src="https://effico.com.br/wp-content/uploads/2022/06/Sem-Titulo-7123.png" class="logo">
  <h1>RH Digital</h1>

  <div id="status" class="status">Carregando sistema...</div>

  <button id="btnIniciar">Iniciar Processo</button>

  <div class="camera-box" id="cameraBox">
    <video id="video" autoplay playsinline muted></video>
    <div class="overlay">
      <div id="mask" class="mask"></div>
    </div>
  </div>

  <button id="btnEnviar" style="display:none">Enviar Documentos</button>
</div>

<canvas id="canvas"></canvas>

<!-- LIBS -->
<script async src="https://docs.opencv.org/4.x/opencv.js" onload="cvReady=true"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
let cvReady=false;
const esperarCV=()=>new Promise(r=>{
  const i=setInterval(()=>{ if(cvReady){clearInterval(i);r();} },100);
});

const video=document.getElementById('video');
const canvas=document.getElementById('canvas');
const status=document.getElementById('status');
const cameraBox=document.getElementById('cameraBox');
const mask=document.getElementById('mask');
const btnIniciar=document.getElementById('btnIniciar');
const btnEnviar=document.getElementById('btnEnviar');

const etapas=[
 {label:'Selfie',key:'selfie',mode:'user',tipo:'face'},
 {label:'RG',key:'rg',mode:'environment',tipo:'doc'},
 {label:'Comprovante de Endereço',key:'endereco',mode:'environment',tipo:'doc'}
];

let idx=0;
let fotos={};
let streamAtual=null;

// ---------- LOAD ----------
async function load(){
 const url='https://justadudewhohacks.github.io/face-api.js/models';
 await faceapi.nets.tinyFaceDetector.loadFromUri(url);
 status.innerText='Sistema pronto';
}
load();

// ---------- START (USER GESTURE) ----------
btnIniciar.onclick = async ()=>{
 btnIniciar.style.display='none';
 cameraBox.style.display='block';
 status.innerText='Abrindo câmera...';

 await iniciarCamera('user');
 next();
};

// ---------- CAMERA ----------
async function iniciarCamera(facing){
 try{
  if(streamAtual) streamAtual.getTracks().forEach(t=>t.stop());

  streamAtual = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:facing },
    audio:false
  });

  video.srcObject = streamAtual;
  await video.play();
 }catch(e){
  status.innerText='Erro ao acessar câmera';
  console.error(e);
 }
}

// ---------- NEXT ----------
async function next(){
 if(idx>=etapas.length){
  finish(); return;
 }

 const e=etapas[idx];
 status.innerText=`Posicione: ${e.label}`;

 mask.className='mask'+(e.tipo==='doc'?' doc':'');
 mask.classList.remove('ok');

 await iniciarCamera(e.mode);
 detectar(e);
}

// ---------- DETECÇÃO ----------
async function detectar(e){
 await esperarCV();

 const loop=setInterval(async()=>{
  if(video.paused) return;
  let ok=false;

  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext('2d').drawImage(video,0,0);

  if(e.tipo==='face'){
   const face=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
   if(face){
    const area=face.box.width*face.box.height;
    const ref=canvas.width*canvas.height;
    if(area>ref*0.08 && area<ref*0.25) ok=true;
    status.innerText = area<ref*0.08 ? 'Aproxime o rosto' : 'Centralize o rosto';
   }else{
    status.innerText='Posicione o rosto';
   }
  }else{
   let src=cv.imread(canvas),g=new cv.Mat(),e1=new cv.Mat();
   cv.cvtColor(src,g,cv.COLOR_RGBA2GRAY);
   cv.Canny(g,e1,80,200);
   let c=new cv.MatVector(),h=new cv.Mat();
   cv.findContours(e1,c,h,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);
   for(let i=0;i<c.size();i++){
    if(cv.contourArea(c.get(i))>canvas.width*canvas.height*0.15){ ok=true; break; }
   }
   src.delete();g.delete();e1.delete();c.delete();h.delete();
   status.innerText = ok ? 'Documento centralizado' : 'Centralize o documento';
  }

  mask.classList.toggle('ok',ok);

  if(ok){
   clearInterval(loop);
   setTimeout(()=>capturar(e),800);
  }
 },400);
}

// ---------- CAPTURA ----------
function capturar(e){
 canvas.getContext('2d').drawImage(video,0,0);
 fotos[e.key]=canvas.toDataURL('image/jpeg');
 idx++;
 next();
}

// ---------- FINAL ----------
function finish(){
 if(streamAtual) streamAtual.getTracks().forEach(t=>t.stop());
 cameraBox.style.display='none';
 status.innerText='Processo concluído';
 btnEnviar.style.display='block';
}

btnEnviar.onclick=async()=>{
 status.innerText='Enviando...';
 await fetch('https://SEU_FLUXO_POWER_AUTOMATE', {
  method:'POST',
  headers:{'Content-Type':'application/json'},
  body:JSON.stringify({fotos})
 });
 status.innerText='Enviado com sucesso';
};
</script>

</body>
</html>

