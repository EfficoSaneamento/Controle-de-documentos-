<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>
<style>
/* ---------- Reset & Body ---------- */
body {
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background: linear-gradient(135deg,#00c6ff,#0072ff);
  display:flex;
  justify-content:center;
  align-items:flex-start;
  padding-top:20px;
}

/* ---------- Container ---------- */
.container {
  background:#fff;
  padding:20px;
  border-radius:20px;
  box-shadow:0 15px 35px rgba(0,0,0,0.25);
  width:95%;
  max-width:500px;
  text-align:center;
  position:relative;
}

/* ---------- Logo ---------- */
.logo {
  position:absolute;
  top:15px;
  left:15px;
  width:100px;
}

/* ---------- Título ---------- */
h1{
  color:#0072ff;
  margin-bottom:20px;
  font-size:1.8rem;
  font-weight:bold;
}

/* ---------- Video ---------- */
video {
  width:100%;
  border-radius:16px;
  border:2px solid #ccc;
}

/* ---------- Canvas ---------- */
canvas{display:none;}

/* ---------- Overlay ---------- */
#overlay {
  position:absolute;
  top:80px;
  left:50%;
  transform:translateX(-50%);
  border:4px solid red;
  width:320px;
  height:240px;
  border-radius:16px;
  pointer-events:none;
  display:none;
  box-shadow:0 0 20px rgba(255,0,0,0.5);
  transition: border 0.2s, box-shadow 0.2s;
}

/* ---------- Status ---------- */
.status{
  margin-top:15px;
  font-weight:bold;
  min-height:24px;
  color:#333;
  font-size:1rem;
  transition: all 0.3s;
}

/* ---------- Inputs ---------- */
input[type=text]{
  width:100%;
  padding:8px;
  border-radius:10px;
  border:1px solid #ccc;
  margin-top:5px;
  margin-bottom:5px;
  font-size:1rem;
}

/* ---------- Botão Enviar ---------- */
.send-btn{
  width:100%;
  background:#00c853;
  color:#fff;
  padding:14px;
  border:none;
  border-radius:12px;
  font-size:16px;
  cursor:pointer;
  margin-top:15px;
  transition: all 0.3s;
}
.send-btn:hover{
  background:#00e676;
}
</style>
</head>
<body>

<div class="container">
  <img src="https://i.imgur.com/4QfKuz1.png" class="logo" alt="EFFICO Logo">

  <h1><i class="fas fa-folder-open"></i> RH Digital</h1>

  <form id="formDocumentos">
    <div><label>Nome</label><input type="text" id="nome"></div>
    <div><label>CPF</label><input type="text" id="cpf"></div>
    <div><label>RG</label><input type="text" id="rg"></div>
    <div><label>Data de Nascimento</label><input type="text" id="nascimento"></div>
    <button type="button" class="send-btn" onclick="enviarDocumentos()">Enviar Tudo</button>
    <div class="status" id="status">Aguardando início...</div>
  </form>

  <video id="video" autoplay></video>
  <canvas id="canvas"></canvas>
  <div id="overlay"></div>
</div>

<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>
<script>
// ---------- Sequência de Documentos ----------
const sequenciaDocs = [
  {label:"Foto Selfie (Crachá)",key:"selfie",selfie:true,ocr:false},
  {label:"RG",key:"rgDoc",selfie:false,ocr:true},
  {label:"CTPS",key:"ctps",selfie:false,ocr:true},
  {label:"Comprovante de Endereço",key:"endereco",selfie:false,ocr:true}
];

const video = document.getElementById('video');
const canvas = document.getElementById('canvas');
const overlay = document.getElementById('overlay');
const status = document.getElementById('status');
const arquivos = {};
let currentIndex = 0;
let captureInterval = null;

// ---------- Função para iniciar sequência ----------
async function startSequencia(){
  if(currentIndex >= sequenciaDocs.length){
    status.innerText="Todos os documentos capturados!";
    return;
  }
  const doc = sequenciaDocs[currentIndex];
  status.innerText=`Capture: ${doc.label}`;
  overlay.style.display="block";
  overlay.style.borderColor="red";
  video.style.display="block";

  const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:doc.selfie?'user':'environment'}});
  video.srcObject = stream;

  if(doc.selfie) await faceapi.nets.tinyFaceDetector.loadFromUri('/models');

  captureInterval = setInterval(async ()=>{
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    const ctx = canvas.getContext('2d');
    ctx.drawImage(video,0,0);
    let ok = false;

    if(doc.selfie){
      const detection = await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
      if(detection){
        const box=detection.box;
        const cx=box.x+box.width/2;
        const cy=box.y+box.height/2;
        const dist=Math.sqrt((cx-video.videoWidth/2)**2 + (cy-video.videoHeight/2)**2);
        if(dist<50 && box.width>video.videoWidth*0.3) ok=true;
      }
    }else{
      const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
      if(calcVariance(imgData)>500) ok=true;
    }

    overlay.style.borderColor = ok ? "green" : "red";
    overlay.style.boxShadow = ok ? "0 0 20px rgba(0,255,0,0.5)" : "0 0 20px rgba(255,0,0,0.5)";
    status.innerText = ok ? `Ajuste ok! Tirando foto de ${doc.label}...` : `Ajuste ${doc.label} dentro do quadro`;

    if(ok && !arquivos[doc.key]){
      // ---------- Contagem regressiva ----------
      let count=3;
      const countdown = setInterval(()=>{
        status.innerText = `Foto de ${doc.label} em ${count}...`;
        count--;
        if(count<0){
          clearInterval(countdown);
          arquivos[doc.key] = canvas.toDataURL('image/jpeg');
          if(doc.ocr) processOCR(canvas, doc.key);
          clearInterval(captureInterval);
          video.srcObject.getTracks().forEach(track=>track.stop());
          video.style.display="none";
          overlay.style.display="none";
          status.innerText = `${doc.label} capturado com sucesso!`;
          currentIndex++;
          setTimeout(()=>startSequencia(), 1000); // Próximo documento
        }
      },1000);
    }
  }, 500);
}

// ---------- OCR ----------
async function processOCR(canvas,key){
  const result = await Tesseract.recognize(canvas,'por',{logger:m=>console.log(m)});
  const text = result.data.text;
  if(!text) return;
  if(key==='rgDoc'){
    const nomeMatch = text.match(/NOME[:\s]*([A-ZÀ-Ÿ ]+)/i);
    const nascimentoMatch = text.match(/NASC(?:IMENTO)?[:\s]*(\d{2}\/\d{2}\/\d{4})/i);
    const rgMatch = text.match(/RG[:\s]*([\d\.]+)/i);
    const cpfMatch = text.match(/CPF[:\s]*(\d{3}\.\d{3}\.\d{3}-\d{2})/i);
    if(nomeMatch) document.getElementById('nome').value = nomeMatch[1].trim();
    if(nascimentoMatch) document.getElementById('nascimento').value = nascimentoMatch[1].trim();
    if(rgMatch) document.getElementById('rg').value = rgMatch[1].trim();
    if(cpfMatch) document.getElementById('cpf').value = cpfMatch[1].trim();
  }
}

// ---------- Nitidez ----------
function calcVariance(imgData){
  let gray=[];
  for(let i=0;i<imgData.data.length;i+=4){
    gray.push(0.299*imgData.data[i]+0.587*imgData.data[i+1]+0.114*imgData.data[i+2]);
  }
  let mean = gray.reduce((a,b)=>a+b)/gray.length;
  let variance = gray.reduce((a,b)=>a+(b-mean)**2,0)/gray.length;
  return variance;
}

// ---------- Enviar ----------
async function enviarDocumentos(){
  sequenciaDocs.forEach(d=>{arquivos[d.key]=arquivos[d.key]||null;});
  arquivos['nome'] = document.getElementById('nome').value;
  arquivos['cpf'] = document.getElementById('cpf').value;
  arquivos['rg'] = document.getElementById('rg').value;
  arquivos['nascimento'] = document.getElementById('nascimento').value;
  status.innerText="Enviando...";
  try{
    await fetch("URL_DO_WEBHOOK_DO_POWER_AUTOMATE",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(arquivos)});
    status.innerText="Todos os documentos enviados!";
  }catch(e){console.error(e);status.innerText="Erro ao enviar!";}
}

// ---------- Iniciar sequencia ----------
startSequencia();
</script>

</body>
</html>

