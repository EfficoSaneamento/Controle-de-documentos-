<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>EFFICO | ValidaÃ§Ã£o de Documentos</title>

<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>
body{
  margin:0;
  font-family: Arial, sans-serif;
  background: linear-gradient(135deg,#00c6ff,#0072ff);
  color:#fff;
}

header{
  padding:15px;
  display:flex;
  align-items:center;
  gap:10px;
}

header img{
  height:40px;
}

.container{
  max-width:420px;
  margin:auto;
  padding:20px;
}

.card{
  background:#fff;
  color:#333;
  border-radius:16px;
  padding:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.2);
}

video,canvas{
  width:100%;
  border-radius:12px;
}

.mask{
  position:absolute;
  inset:10%;
  border:4px solid red;
  border-radius:12px;
  pointer-events:none;
}

.mask.ok{
  border-color:green;
}

.hidden{display:none}

.buttons{
  display:flex;
  gap:10px;
  margin-top:10px;
}

button{
  flex:1;
  padding:12px;
  border:none;
  border-radius:10px;
  background:#0072ff;
  color:#fff;
  font-size:15px;
  cursor:pointer;
}
</style>
</head>

<body>

<header>
  <img src="logo-effico.png">
  <strong>ValidaÃ§Ã£o de Documentos</strong>
</header>

<div class="container">

<!-- LGPD -->
<div class="card" id="lgpd">
  <h3>ProteÃ§Ã£o de Dados (LGPD)</h3>
  <p>Seus dados serÃ£o usados exclusivamente para fins de admissÃ£o,
  armazenados de forma segura e conforme a Lei Geral de ProteÃ§Ã£o de Dados.</p>
  <label>
    <input type="checkbox" id="aceite"> Li e concordo
  </label>
  <button onclick="iniciar()">Iniciar</button>
</div>

<!-- Sistema -->
<div class="card hidden" id="sistema">
  <h3 id="titulo"></h3>

  <div style="position:relative">
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" class="hidden"></canvas>
    <div id="mask" class="mask hidden"></div>
  </div>

  <div class="buttons">
    <button onclick="usarCamera()">ðŸ“· Tirar foto</button>
    <button onclick="anexar()">ðŸ“Ž Anexar</button>
  </div>

  <input type="file" id="file" accept="image/*" class="hidden">

  <p id="status"></p>
</div>

</div>

<script>
const etapas = [
  {id:"selfie", nome:"Selfie", tipo:"face"},
  {id:"rg", nome:"RG", tipo:"rg"},
  {id:"cpf", nome:"CPF", tipo:"cpf"},
  {id:"ctps", nome:"CTPS", tipo:"doc"},
  {id:"cnh", nome:"CNH", tipo:"doc"}
];

let etapaAtual = 0;
let fotos = {};
let stream;

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d",{willReadFrequently:true});
const mask = document.getElementById("mask");
const status = document.getElementById("status");

function iniciar(){
  if(!document.getElementById("aceite").checked){
    alert("Ã‰ necessÃ¡rio aceitar a LGPD");
    return;
  }
  document.getElementById("lgpd").classList.add("hidden");
  document.getElementById("sistema").classList.remove("hidden");
  carregarEtapa();
}

function carregarEtapa(){
  const e = etapas[etapaAtual];
  document.getElementById("titulo").innerText = "Documento: " + e.nome;
  status.innerText="";
  mask.className="mask hidden";
  pararCamera();
}

async function usarCamera(){
  const e = etapas[etapaAtual];

  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: e.id==="selfie" ? "user":"environment" }
  });

  video.srcObject = stream;
  mask.classList.remove("hidden");

  if(e.tipo==="face"){
    mask.style.borderRadius="50%";
  }else{
    mask.style.borderRadius="12px";
  }
}

function pararCamera(){
  if(stream){
    stream.getTracks().forEach(t=>t.stop());
    stream=null;
  }
}

function capturar(){
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  ctx.drawImage(video,0,0);
  fotos[etapas[etapaAtual].id] = canvas.toDataURL("image/jpeg");
  pararCamera();
  validarOCR();
}

function anexar(){
  const f = document.getElementById("file");
  f.onchange=()=>{
    const r = new FileReader();
    r.onload=()=>{
      fotos[etapas[etapaAtual].id]=r.result;
      validarOCR();
    };
    r.readAsDataURL(f.files[0]);
  };
  f.click();
}

async function validarOCR(){
  const etapa = etapas[etapaAtual];
  status.innerText="Validando documento...";

  if(etapa.tipo==="face"){
    avancar();
    return;
  }

  const img = fotos[etapa.id];
  const res = await Tesseract.recognize(img,"por");
  const txt = res.data.text.toUpperCase();

  let valido=false;

  if(etapa.tipo==="rg"){
    valido = txt.includes("NOME") && txt.match(/\d{3}\.\d{3}\.\d{3}-\d{2}/);
  }
  if(etapa.tipo==="cpf"){
    valido = txt.match(/\d{3}\.\d{3}\.\d{3}-\d{2}/);
  }
  if(etapa.tipo==="doc"){
    valido = txt.length>30;
  }

  if(valido){
    status.innerText="âœ… Documento validado";
    avancar();
  }else{
    status.innerText="âŒ Documento invÃ¡lido. Tente novamente";
  }
}

function avancar(){
  etapaAtual++;
  if(etapaAtual>=etapas.length){
    status.innerText="ðŸ“¤ Enviando...";
    enviar();
  }else{
    carregarEtapa();
  }
}

async function enviar(){
  await fetch("https://script.google.com/macros/s/AKfycbxMomceUR5DQWAIt-m2kt9Dmv6h3sLm0K0Gp-yQPfSTt3reJJBTlElnoNmDixynMrIbSQ/exec",{
    method:"POST",
    mode:"no-cors",
    body: JSON.stringify({fotos})
  });
  status.innerText="âœ… Processo finalizado";
}
</script>

</body>
</html>

