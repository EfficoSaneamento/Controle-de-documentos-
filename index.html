<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
:root{
  --primary:#687b58;
  --secondary:#003399;
}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#f0f2f5;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container{
  background:#fff;
  max-width:480px;
  width:100%;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}
.logo{width:120px;margin-bottom:10px;}
h1{font-size:1.4rem;color:var(--secondary);}
.status{
  background:#e3f2fd;
  color:#0d47a1;
  padding:10px;
  border-radius:8px;
  margin:15px 0;
  font-size:.9rem;
}
.camera-box{
  position:relative;
  width:100%;
  aspect-ratio:4/3;
  background:#000;
  border-radius:14px;
  overflow:hidden;
  display:none;
}
video{width:100%;height:100%;object-fit:cover;}
.overlay{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:70%;
  height:80%;
  border:3px solid red;
  border-radius:20px;
  box-shadow:0 0 0 1000px rgba(0,0,0,.6);
  transition:.3s;
  pointer-events:none;
}
.overlay.selfie{border-radius:50%;}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  font-size:1rem;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
.btn:disabled{background:#ccc;}
.lgpd{
  text-align:left;
  font-size:.85rem;
  background:#f8f9fa;
  padding:12px;
  border-radius:8px;
  margin-bottom:10px;
}
canvas{display:none;}
</style>
</head>

<body>

<div class="container">

<img src="https://effico.com.br/wp-content/uploads/2022/06/Sem-Titulo-7123.png" class="logo">
<h1>RH Digital</h1>

<!-- LGPD -->
<div id="lgpd" class="lgpd">
<b>Proteção de Dados (LGPD)</b><br><br>
Ao prosseguir, você autoriza a coleta e o tratamento dos seus dados pessoais e documentos,
exclusivamente para fins de admissão, conforme a Lei Geral de Proteção de Dados (Lei nº 13.709/2018).
</div>

<label>
<input type="checkbox" id="aceiteLGPD"> Li e concordo com o uso dos meus dados.
</label>

<button id="btnStart" class="btn" disabled>Iniciar</button>

<div id="status" class="status">Aguardando consentimento</div>

<div class="camera-box" id="cameraBox">
  <video id="video" autoplay playsinline></video>
  <div id="overlay" class="overlay"></div>
</div>

<button id="btnEnviar" class="btn" style="display:none;">Enviar Documentos</button>

</div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
const etapas = [
  {label:"Selfie", key:"selfie", face:true},
  {label:"RG", key:"rg"},
  {label:"CPF", key:"cpf"},
  {label:"Comprovante de Endereço", key:"endereco"}
];

let etapaAtual = 0;
let fotos = {};
let stream;

const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const cameraBox = document.getElementById("cameraBox");
const status = document.getElementById("status");
const canvas = document.getElementById("canvas");

document.getElementById("aceiteLGPD").onchange = e=>{
  document.getElementById("btnStart").disabled = !e.target.checked;
};

document.getElementById("btnStart").onclick = iniciarFluxo;

async function iniciarFluxo(){
  document.getElementById("lgpd").style.display="none";
  document.getElementById("btnStart").style.display="none";
  cameraBox.style.display="block";
  await faceapi.nets.tinyFaceDetector.loadFromUri("https://justadudewhohacks.github.io/face-api.js/models");
  iniciarCamera();
}

async function iniciarCamera(){
  if(etapaAtual >= etapas.length){ finalizar(); return; }

  if(stream) stream.getTracks().forEach(t=>t.stop());

  const etapa = etapas[etapaAtual];

  stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode: etapa.face ? "user":"environment" }
  });

  video.srcObject = stream;
  overlay.classList.toggle("selfie", !!etapa.face);
  status.innerText = "Enquadre: " + etapa.label;

  detectar(etapa);
}

async function detectar(etapa){
  const loop = setInterval(async ()=>{
    let ok=false;
    let msg="";

    if(etapa.face){
      const face = await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
      if(face){
        const area = face.box.width * face.box.height;
        if(area < 12000) msg="Aproxime o rosto";
        else if(area > 50000) msg="Afaste o rosto";
        else ok=true;
      }
    } else {
      canvas.width=video.videoWidth;
      canvas.height=video.videoHeight;
      const ctx=canvas.getContext("2d");
      ctx.drawImage(video,0,0);
      const img = ctx.getImageData(0,0,canvas.width,canvas.height);
      let variance=0,mean=0;
      for(let i=0;i<img.data.length;i+=4){
        const v=(img.data[i]+img.data[i+1]+img.data[i+2])/3;
        mean+=v;
      }
      mean/=img.data.length/4;
      for(let i=0;i<img.data.length;i+=4){
        const v=(img.data[i]+img.data[i+1]+img.data[i+2])/3;
        variance+=(v-mean)**2;
      }
      variance/=img.data.length/4;
      if(variance<80) msg="Imagem desfocada";
      else ok=true;
    }

    status.innerText = ok ? "Capturando..." : msg || "Ajuste o enquadramento";
    overlay.style.borderColor = ok ? "lime":"red";

    if(ok){
      clearInterval(loop);
      capturar();
    }
  },700);
}

async function capturar(){
  canvas.width=video.videoWidth;
  canvas.height=video.videoHeight;
  canvas.getContext("2d").drawImage(video,0,0);
  fotos[etapas[etapaAtual].key] = canvas.toDataURL("image/jpeg");
  etapaAtual++;
  iniciarCamera();
}

function finalizar(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  cameraBox.style.display="none";
  document.getElementById("btnEnviar").style.display="block";
  status.innerText="Pronto para envio";
}

document.getElementById("btnEnviar").onclick = async ()=>{
  await fetch("https://script.google.com/macros/s/AKfycbym5sK0oqUJYqbAPCmg_qpB89w0Il9w5dc-fjWx0LLpcud7ikBs4VjmBetl0vEI43Wklg/exec",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({fotos})
  });
  status.innerText="✅ Documentos enviados com sucesso";
};
</script>

</body>
</html>

