<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
:root{
  --primary:#00c853;
  --danger:#d32f2f;
  --bg:#f2f4f7;
}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--bg);
  display:flex;
  justify-content:center;
  padding:20px;
}
.container{
  background:#fff;
  max-width:420px;
  width:100%;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,.15);
  padding:24px;
}
.logo{
  width:110px;
  margin-bottom:10px;
}
h1{
  margin:5px 0 20px;
  font-size:1.3rem;
  color:#003399;
}
.status{
  background:#eef3ff;
  padding:12px;
  border-radius:10px;
  font-size:.9rem;
  margin-bottom:15px;
}
.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  font-size:1rem;
  font-weight:bold;
  cursor:pointer;
}
.btn-primary{background:var(--primary);color:#fff;}
.btn-outline{
  border:2px solid var(--primary);
  background:#fff;
  color:var(--primary);
  margin-top:10px;
}

.camera-box{
  position:relative;
  width:100%;
  aspect-ratio:4/3;
  background:#000;
  border-radius:16px;
  overflow:hidden;
  margin:15px 0;
  display:none;
}
video{width:100%;height:100%;object-fit:cover;}

#overlay{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:70%;
  height:75%;
  border:3px solid var(--danger);
  border-radius:22px;
  box-shadow:0 0 0 9999px rgba(0,0,0,.55);
  transition:.3s;
}
.selfie #overlay{
  border-radius:50%;
}

.hidden{display:none;}
canvas{display:none;}
</style>
</head>

<body>
<div class="container">

<img src="https://effico.com.br/wp-content/uploads/2022/06/Sem-Titulo-7123.png" class="logo">
<h1>RH Digital</h1>

<!-- LGPD -->
<div id="lgpd">
  <div class="status">
    Ao continuar, você autoriza o tratamento dos seus dados pessoais
    conforme a <b>LGPD (Lei 13.709/2018)</b>, exclusivamente para fins
    de admissão.
  </div>
  <button class="btn btn-primary" onclick="aceitarLGPD()">Aceitar e iniciar</button>
</div>

<div id="status" class="status hidden"></div>

<div id="cameraBox" class="camera-box">
  <video id="video" autoplay playsinline></video>
  <div id="overlay"></div>
</div>

<div id="acoes" class="hidden">
  <button class="btn btn-primary" onclick="usarCamera()">Tirar foto</button>
  <button class="btn btn-outline" onclick="anexarArquivo()">Anexar arquivo</button>
  <input type="file" id="fileInput" class="hidden" accept="image/*">
</div>

<button id="btnEnviar" class="btn btn-primary hidden" onclick="enviar()">Enviar documentos</button>

</div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.1.1/dist/tesseract.min.js"></script>

<script>
const etapas = [
 {label:"Selfie",key:"selfie",mode:"user",tipo:"selfie"},
 {label:"RG Frente",key:"rg_frente",mode:"environment",tipo:"rg"},
 {label:"RG Verso",key:"rg_verso",mode:"environment",tipo:"rg"},
 {label:"CPF",key:"cpf",mode:"environment",tipo:"cpf"},
 {label:"CNH",key:"cnh",mode:"environment",tipo:"cnh"},
 {label:"CTPS",key:"ctps",mode:"environment",tipo:"ctps"}
];

let index=0;
let fotos={};

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const overlay=document.getElementById("overlay");
const status=document.getElementById("status");
const cameraBox=document.getElementById("cameraBox");

async function aceitarLGPD(){
 document.getElementById("lgpd").remove();
 status.classList.remove("hidden");
 iniciar();
}

async function iniciar(){
 await faceapi.nets.tinyFaceDetector.loadFromUri(
  "https://justadudewhohacks.github.io/face-api.js/models"
 );
 proximo();
}

function proximo(){
 if(index>=etapas.length){
   status.innerText="Processo concluído";
   document.getElementById("btnEnviar").classList.remove("hidden");
   cameraBox.classList.add("hidden");
   return;
 }
 status.innerText="Documento: "+etapas[index].label;
 document.getElementById("acoes").classList.remove("hidden");
}

async function usarCamera(){
 const etapa=etapas[index];
 cameraBox.classList.remove("hidden");
 overlay.className="";
 if(etapa.tipo==="selfie") cameraBox.classList.add("selfie");

 const stream=await navigator.mediaDevices.getUserMedia({
  video:{facingMode:etapa.mode}
 });
 video.srcObject=stream;
 detectar(etapa);
}

function detectar(etapa){
 const loop=setInterval(async()=>{
  let ok=false;

  if(etapa.tipo==="selfie"){
   const face=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
   if(face){
    const area=face.box.width*face.box.height;
    if(area>15000 && area<50000){
      ok=true;
    }else{
      status.innerText=area<15000?"Aproxime o rosto":"Afaste o rosto";
    }
   }
  }else{
   ok=true; // documentos via OCR + opção anexo
  }

  overlay.style.borderColor=ok?"#00c853":"#d32f2f";

  if(ok){
   clearInterval(loop);
   capturar(etapa);
  }
 },700);
}

function capturar(etapa){
 canvas.width=video.videoWidth;
 canvas.height=video.videoHeight;
 canvas.getContext("2d").drawImage(video,0,0);
 fotos[etapa.key]=canvas.toDataURL("image/jpeg");
 if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
 index++;
 proximo();
}

function anexarArquivo(){
 document.getElementById("fileInput").click();
}

document.getElementById("fileInput").onchange=e=>{
 const reader=new FileReader();
 reader.onload=()=>{
  fotos[etapas[index].key]=reader.result;
  index++;
  proximo();
 };
 reader.readAsDataURL(e.target.files[0]);
};

async function enviar(){
 status.innerText="Enviando...";
 await fetch("https://script.google.com/macros/s/AKfycbzCWGlR2Dw3m27wfS0P7OtzwTCTgmxbyJR3kwIhVusNt5CkHoZAyJ5sC6GPIDjeC766/exec",{
  method:"POST",
  headers:{"Content-Type":"application/json"},
  body:JSON.stringify({fotos})
 });
 status.innerText="Enviado com sucesso!";
}
</script>
</body>
</html>



