<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
:root{
  --verde:#00c853;
  --vermelho:#ff3b3b;
  --primaria:#687b58;
  --fundo:#f0f2f5;
}

body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:var(--fundo);
  display:flex;
  justify-content:center;
  padding:20px;
}

.container{
  background:#fff;
  width:100%;
  max-width:460px;
  padding:20px;
  border-radius:18px;
  box-shadow:0 15px 30px rgba(0,0,0,.15);
  text-align:center;
}

.logo{
  width:120px;
  margin-bottom:10px;
}

.status{
  background:#e8f5e9;
  color:#1b5e20;
  padding:12px;
  border-radius:10px;
  font-weight:600;
  margin-bottom:15px;
}

.input-group{
  text-align:left;
  margin-bottom:10px;
}
label{
  font-size:.8rem;
  font-weight:600;
  color:#555;
}
input{
  width:100%;
  padding:10px;
  border-radius:8px;
  border:1px solid #ddd;
}

.camera{
  position:relative;
  width:100%;
  aspect-ratio:3/4;
  background:#000;
  border-radius:16px;
  overflow:hidden;
  display:none;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.overlay{
  position:absolute;
  inset:0;
  box-shadow:0 0 0 2000px rgba(0,0,0,.55);
  display:flex;
  justify-content:center;
  align-items:center;
  pointer-events:none;
  transition:.3s;
}

.guia-rosto{
  width:65%;
  height:75%;
  border:3px solid white;
  border-radius:50%;
}

.guia-doc{
  width:75%;
  height:55%;
  border:3px solid white;
  border-radius:12px;
}

.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:10px;
  background:var(--primaria);
  color:#fff;
  font-weight:700;
  font-size:1rem;
  cursor:pointer;
}

canvas{display:none;}
</style>
</head>

<body>

<div class="container">

<img class="logo" src="https://effico.com.br/wp-content/uploads/2022/06/Sem-Titulo-7123.png">

<div id="status" class="status">Inicializando sistema...</div>

<div id="form">
  <div class="input-group"><label>Nome Completo</label><input id="nome"></div>
  <div class="input-group"><label>Função contratada</label><input id="cpf"></div>
  <button class="btn" onclick="iniciar()">Iniciar</button>
</div>

<div id="camera" class="camera">
  <video id="video" autoplay playsinline></video>
  <div id="overlay" class="overlay"></div>
</div>

</div>

<canvas id="canvas"></canvas>

<script src="https://docs.opencv.org/4.x/opencv.js"></script>
<script src="https://cdn.jsdelivr.net/npm/face-api.js"></script>
<script src="https://cdn.jsdelivr.net/npm/tesseract.js"></script>

<script>
const etapas=[
 {nome:"Selfie",key:"selfie",face:true,camera:"user"},
 {nome:"RG Frente",key:"rg_frente",camera:"environment",ocr:true},
 {nome:"RG Verso",key:"rg_verso",camera:"environment"}
];

let etapaAtual=0, estabilidade=0, fotos={};

const video=document.getElementById("video");
const canvas=document.getElementById("canvas");
const status=document.getElementById("status");
const camera=document.getElementById("camera");
const overlay=document.getElementById("overlay");

async function iniciar(){
 document.getElementById("form").style.display="none";
 camera.style.display="block";
 await faceapi.nets.tinyFaceDetector.loadFromUri("https://justadudewhohacks.github.io/face-api.js/models");
 proxima();
}

async function proxima(){
 if(etapaAtual>=etapas.length){
   status.innerText="Processo finalizado!";
   return;
 }

 estabilidade=0;
 const e=etapas[etapaAtual];
 status.innerText=`Capture: ${e.nome}`;

 overlay.innerHTML=e.face
  ?'<div class="guia-rosto"></div>'
  :'<div class="guia-doc"></div>';

 if(video.srcObject) video.srcObject.getTracks().forEach(t=>t.stop());
 const stream=await navigator.mediaDevices.getUserMedia({video:{facingMode:e.camera}});
 video.srcObject=stream;

 detectar();
}

function detectar(){
 const loop=setInterval(async()=>{
   canvas.width=video.videoWidth;
   canvas.height=video.videoHeight;
   canvas.getContext("2d").drawImage(video,0,0);

   let valido=false;

   if(etapas[etapaAtual].face){
     const face=await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
     valido=!!face;
   }else{
     let src=cv.imread(canvas);
     let gray=new cv.Mat();
     cv.cvtColor(src,gray,cv.COLOR_RGBA2GRAY);
     let edges=new cv.Mat();
     cv.Canny(gray,edges,80,200);
     let cont=new cv.MatVector(), hier=new cv.Mat();
     cv.findContours(edges,cont,hier,cv.RETR_EXTERNAL,cv.CHAIN_APPROX_SIMPLE);

     let maior=0;
     for(let i=0;i<cont.size();i++){
       maior=Math.max(maior,cv.contourArea(cont.get(i)));
     }

     let perc=maior/(canvas.width*canvas.height);

     if(perc<0.22) erro("Aproxime o documento");
     else if(perc>0.55) erro("Afaste um pouco");
     else valido=true;

     src.delete();gray.delete();edges.delete();cont.delete();hier.delete();
   }

   if(valido){
     estabilidade++;
     ok();
   }else estabilidade=0;

   if(estabilidade>=3){
     clearInterval(loop);
     capturar();
   }
 },500);
}

function erro(msg){
 status.innerText=msg;
 overlay.style.boxShadow="0 0 0 2000px rgba(255,59,59,.4)";
}

function ok(){
 status.innerText="Perfeito, mantenha";
 overlay.style.boxShadow="0 0 0 2000px rgba(0,200,83,.25)";
}

async function capturar(){
 canvas.getContext("2d").drawImage(video,0,0);
 fotos[etapas[etapaAtual].key]=canvas.toDataURL("image/jpeg");

 if(etapas[etapaAtual].ocr) await ocr();

 etapaAtual++;
 proxima();
}

async function ocr(){
 const r=await Tesseract.recognize(canvas,'por');
 const t=r.data.text;
 if(!t) return;

 const nome=t.match(/NOME[:\s]*([A-ZÀ-Ÿ ]+)/i);
 const cpf=t.match(/CPF[:\s]*(\d{3}\.\d{3}\.\d{3}-\d{2})/);
 const rg=t.match(/RG[:\s]*([\d\.]+)/);
 const nasc=t.match(/(\d{2}\/\d{2}\/\d{4})/);

 if(nome) nomeInput.value=nome[1];
 if(cpf) cpfInput.value=cpf[1];
 if(rg) rgInput.value=rg[1];
 if(nasc) nascimentoInput.value=nasc[1];
}
</script>

</body>
</html>
