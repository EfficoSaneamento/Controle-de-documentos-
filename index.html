<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>RH Digital - EFFICO</title>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
:root{
  --primary:#687b58;
  --secondary:#003399;
}
body{
  margin:0;
  font-family:'Segoe UI',sans-serif;
  background:#f0f2f5;
  display:flex;
  justify-content:center;
  padding:20px;
}
.container{
  background:#fff;
  max-width:480px;
  width:100%;
  padding:20px;
  border-radius:16px;
  box-shadow:0 10px 25px rgba(0,0,0,.15);
  text-align:center;
}
.logo{width:120px;margin-bottom:10px;}
h1{font-size:1.4rem;color:var(--secondary);}

.status{
  background:#e3f2fd;
  color:#0d47a1;
  padding:10px;
  border-radius:8px;
  margin:15px 0;
  font-size:.9rem;
}

.camera-box{
  position:relative;
  width:100%;
  aspect-ratio:4/3;
  background:#000;
  border-radius:14px;
  overflow:hidden;
  display:none;
}

video{
  width:100%;
  height:100%;
  object-fit:cover;
}

.overlay{
  position:absolute;
  top:50%;
  left:50%;
  transform:translate(-50%,-50%);
  width:70%;
  height:80%;
  border:3px solid red;
  border-radius:20px;
  box-shadow:0 0 0 1000px rgba(0,0,0,.6);
  transition:.3s;
  pointer-events:none;
}

.overlay.selfie{
  border-radius:50%;
}

.btn{
  width:100%;
  padding:14px;
  border:none;
  border-radius:8px;
  background:var(--primary);
  color:#fff;
  font-size:1rem;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}

.btn:disabled{background:#ccc;}

input[type=file]{
  display:none;
}

canvas{display:none;}
</style>
</head>

<body>

<div class="container">
  <img src="https://effico.com.br/wp-content/uploads/2022/06/Sem-Titulo-7123.png" class="logo">
  <h1>RH Digital</h1>

  <div id="status" class="status">Carregando sistema...</div>

  <button id="btnStart" class="btn" onclick="start()" disabled>Iniciar</button>

  <div class="camera-box" id="cameraBox">
    <video id="video" autoplay playsinline></video>
    <div id="overlay" class="overlay"></div>
  </div>

  <label class="btn" id="btnUpload" style="display:none;">
    Anexar documento
    <input type="file" accept="image/*" onchange="uploadManual(this)">
  </label>

  <button id="btnEnviar" class="btn" style="display:none;" onclick="enviar()">Enviar Documentos</button>
</div>

<canvas id="canvas"></canvas>

<script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

<script>
const video = document.getElementById("video");
const overlay = document.getElementById("overlay");
const cameraBox = document.getElementById("cameraBox");
const status = document.getElementById("status");
const canvas = document.getElementById("canvas");

const etapas = [
  {label:"Selfie", key:"selfie", face:true},
  {label:"RG", key:"rg"},
  {label:"CPF", key:"cpf"},
  {label:"Comprovante de Endereço", key:"endereco"}
];

let etapaAtual = 0;
let fotos = {};
let stream;

async function loadModels(){
  await faceapi.nets.tinyFaceDetector.loadFromUri("https://justadudewhohacks.github.io/face-api.js/models");
  status.innerText = "Sistema pronto";
  document.getElementById("btnStart").disabled = false;
}
loadModels();

async function start(){
  document.getElementById("btnStart").style.display="none";
  cameraBox.style.display="block";
  iniciarCamera();
}

async function iniciarCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  stream = await navigator.mediaDevices.getUserMedia({
    video:{facingMode: etapaAtual===0 ? "user":"environment"}
  });

  video.srcObject = stream;

  overlay.classList.toggle("selfie", etapas[etapaAtual].face);
  status.innerText = "Enquadre: " + etapas[etapaAtual].label;

  detectar();
}

async function detectar(){
  const loop = setInterval(async ()=>{
    let ok = false;

    if(etapas[etapaAtual].face){
      const face = await faceapi.detectSingleFace(video,new faceapi.TinyFaceDetectorOptions());
      ok = !!face;
    } else {
      ok = video.videoWidth > 0;
    }

    overlay.style.borderColor = ok ? "lime" : "red";

    if(ok){
      clearInterval(loop);
      capturar();
    }
  },700);
}

function capturar(){
  setTimeout(()=>{
    canvas.width = video.videoWidth;
    canvas.height = video.videoHeight;
    canvas.getContext("2d").drawImage(video,0,0);
    fotos[etapas[etapaAtual].key] = canvas.toDataURL("image/jpeg");

    etapaAtual++;

    if(etapaAtual < etapas.length){
      iniciarCamera();
    } else {
      finalizar();
    }
  },1000);
}

function uploadManual(input){
  const reader = new FileReader();
  reader.onload = e => {
    fotos[etapas[etapaAtual].key] = e.target.result;
    etapaAtual++;
    iniciarCamera();
  };
  reader.readAsDataURL(input.files[0]);
}

function finalizar(){
  if(stream) stream.getTracks().forEach(t=>t.stop());
  cameraBox.style.display="none";
  document.getElementById("btnUpload").style.display="none";
  document.getElementById("btnEnviar").style.display="block";
  status.innerText="Pronto para enviar";
}

async function enviar(){
  status.innerText="Enviando...";
  await fetch("https://script.google.com/macros/s/AKfycbyl8ocV342DlaSo1qW8TsvtA5t_FFayn2VUWdw-U-xVLa4Ph5SGchKu3nRsu8v3VLginQ/exec",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({dados:{nome:"",cpf:""},fotos})
  });
  status.innerText="✅ Enviado com sucesso";
}
</script>

</body>
</html>
